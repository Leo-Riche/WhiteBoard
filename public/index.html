<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau blanc collaboratif</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

  <h1 class="text-2xl font-bold mb-4">🖌️ Tableau blanc collaboratif</h1>

  <div class="mb-2">
    <input type="color" id="colorPicker" class="w-12 h-12 p-0 border-none cursor-pointer">
    <div class="mb-2 flex gap-2">
      <button id="pencilBtn" class="bg-blue-500 text-white p-2 rounded">✏️ Crayon</button>
      <button id="eraserBtn" class="bg-gray-500 text-white p-2 rounded">🧽 Gomme</button>
      <button id="lineBtn" class="bg-green-500 text-white p-2 rounded">📏 Ligne</button>
    </div>
    <select id="lineWidth" class="ml-2 p-1 border rounded">
      <option value="2">Fin</option>
      <option value="5" selected>Moyen</option>
      <option value="10">Épais</option>
    </select>
    <button id="clearBtn" class="ml-2 bg-red-500 text-white p-2 rounded">Nettoyer</button>
  </div>

  <canvas id="canvas" class="border rounded bg-white" width="800" height="500"></canvas>

  <script>
    const socket = io();
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let drawing = false;

    socket.on('initCanvas', (history) => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      history.forEach(item => {
        if (item.type === 'draw') {
          const data = item.data;
          ctx.strokeStyle = data.color;
          ctx.lineWidth = data.width;
          ctx.lineCap = 'round';

          if (data.start) {
            ctx.beginPath();
            ctx.moveTo(data.x, data.y);
          } else {
            ctx.lineTo(data.x, data.y);
            ctx.stroke();
          }
        } else if (item.type === 'draw_line') {
          const d = item.data;
          ctx.strokeStyle = d.color;
          ctx.lineWidth = d.width;
          ctx.lineCap = 'round';

          ctx.beginPath();
          ctx.moveTo(d.startX, d.startY);
          ctx.lineTo(d.endX, d.endY);
          ctx.stroke();
        }
      });
    });

    const colorPicker = document.getElementById('colorPicker');
    const lineWidth = document.getElementById('lineWidth');
    const clearBtn = document.getElementById('clearBtn');

    let currentTool = 'pencil';
    let startX, startY;
    
    const pencilBtn = document.getElementById('pencilBtn');
    const eraserBtn = document.getElementById('eraserBtn');
    const lineBtn = document.getElementById('lineBtn');
    
    pencilBtn.addEventListener('click', () => currentTool = 'pencil');
    eraserBtn.addEventListener('click', () => currentTool = 'eraser');
    lineBtn.addEventListener('click', () => currentTool = 'line');
    
    canvas.addEventListener('mousedown', (e) => {
      drawing = true;
      ctx.beginPath();
      startX = e.offsetX;
      startY = e.offsetY;

      if (currentTool === 'line') return;

      ctx.moveTo(e.offsetX, e.offsetY);
      socket.emit('draw', {
        x: e.offsetX,
        y: e.offsetY,
        color: currentTool === 'eraser' ? '#FFFFFF' : colorPicker.value,
        width: currentTool === 'eraser' ? 20 : lineWidth.value,
        start: true
      });
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!drawing) return;

      if (currentTool === 'line') return;

      const color = currentTool === 'eraser' ? '#FFFFFF' : colorPicker.value;
      const width = currentTool === 'eraser' ? 20 : lineWidth.value;

      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.strokeStyle = color;
      ctx.lineWidth = width;
      ctx.lineCap = 'round';
      ctx.stroke();

      socket.emit('draw', { x: e.offsetX, y: e.offsetY, color, width, start: false });
    });
    
    canvas.addEventListener('mouseup', (e) => {
      if (currentTool === 'line') {
        const color = colorPicker.value;
        const width = lineWidth.value;

        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        ctx.lineCap = 'round';

        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();

        socket.emit('draw_line', {
          startX,
          startY,
          endX: e.offsetX,
          endY: e.offsetY,
          color,
          width
        });
      }
      drawing = false;
    });

    socket.on('draw', (data) => {
      ctx.strokeStyle = data.color;
      ctx.lineWidth = data.width;
      ctx.lineCap = 'round';

      if (data.start) {
        ctx.beginPath();
        ctx.moveTo(data.x, data.y);
      } else {
        ctx.lineTo(data.x, data.y);
        ctx.stroke();
      }
    });

    socket.on('draw_line', (data) => {
      console.log('Nouvelle ligne:', data);
      ctx.strokeStyle = data.color;
      ctx.lineWidth = data.width;
      ctx.lineCap = 'round';

      ctx.beginPath();
      ctx.moveTo(data.startX, data.startY);
      ctx.lineTo(data.endX, data.endY);
      ctx.stroke();
    });

    clearBtn.addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      socket.emit('clear');
    });

    socket.on('clear', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
  </script>

</body>
</html>
